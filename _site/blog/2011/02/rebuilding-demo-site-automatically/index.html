<!DOCTYPE html>
<!--[if IE 8]> <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width" />
    <title>Rebuilding a demo site automatically</title>
    <meta name="description" content="{ page.description }}" />
    <link rel="shortcut icon" type="image/ico" href="/assets/img/favicon.ico" />
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,400,300,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/assets/css/default.css">
</head>
<body>

<div id="wrapper">
    <div class="section header">
        <div class="container container-centered">
            <div class="row">
                <div class="brand col-sm-6">
                    <a href="/"><img src="/assets/img/logo.jpg" height="60px" width="123px" /></a>
                </div>
                <div class="col-sm-6">
                    <div class="navbar" role="navigation">
                        <div class="container-fluid">
                            <ul class="nav navbar-nav">
                                
                                
                                
                                <li class="active" role="menuitem">
                                    <a href="/">About</a>
                                </li>
                                
                                
                                
                                <li class="" role="menuitem">
                                    <a href="/manifesto">Manifesto</a>
                                </li>
                                
                                
                                
                                <li class="" role="menuitem">
                                    <a href="/blog">Blog</a>
                                </li>
                                
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="section blog">
        <div class="container">
            <div class="row">
                <div class="col-sm-9">
                    <h2>
                        Rebuilding a demo site automatically
                    </h2>
                    <h3 class="text-muted">
                        08 February 2011 by Shayne
                    </h3>
          
                    <p>Recently I have been working on the demo server that will house our various demo sites.</p>

<p>One of the common issues with a demo site is that to preserve its integrity you may need to either restrict access or have a periodic rebuild. Restricting access may work sometimes but it’s likely to inhibit people trying out anything that is administrative in nature. Hence rebuilding the site is a far more appealing alternative.</p>

<p>The idea is basically delete everything and replace with a fresh copy, but to do so with minimum downtime. The result should be  a quick and secure rebuild. With that in mind we set about creating bash script that would rebuild the site as often as required (run as a cron job).</p>

<p>To get started I mapped out the process.</p>

<p><a href="http://www.flickr.com/photos/nooku/5415925562/" title="Site rebuilt workflow by Nooku, on Flickr"><img src="http://farm5.static.flickr.com/4145/5415925562_26ff253fa1.jpg" width="376" height="500" alt="Site rebuilt workflow" /></a></p>

<p>As you can see we do everything using version control which in this case happened to be <a href="http://en.wikipedia.org/wiki/Apache_Subversion">subversion</a>.</p>

<p>By updating then exporting into a temp folder, the longest part of the process is done prior to any impact on the site. I threw in the checkout logic so that the same script could be used to build a brand new site (as in, one that does not already exist).</p>

<p>The first impact on the public site is the dropping of the database unless there have been changes to the repository that required database modifications.</p>

<p>For a typical site the whole process takes 13 seconds when no changes have been committed to subversion, with less than 2 seconds of downtime.<br />
<!--more--></p>

<h3 id="let8217s-speak-code">Let’s speak code</h3>

<p>For those that might find such a script useful, here it is:</p>

<pre class="brush:bash">#! /bin/bash
# A script to build and rebuild a demo site from a svn repository
# -------------------------------------------------------------------------
# Copyright (c) 2010 - 2011 Timble CVBA &lt;http://www.timble.net&gt;
# This script is licensed under GNU GPL version 3.0
# -------------------------------------------------------------------------

# Setup Paramaters
ROOTPATH=/path/to/site
SVNUSER="svn_username"
SVNPASS="svn_password"
SVNURL="https://some.sv.url"
DBUSER="database_username"
DBPASS='database_password'
DB="database_name"
DBSCRIPT=relative/path/to/sql
LOG=/path/to/rebuild.log

# -------------------------------------------------------------------------
# DO NOT CHANGE ANYTHING BELOW UNLESS YOU REALLY KNOW WHAT YOU'RE DOING
# -------------------------------------------------------------------------

START=$(date +%s)

echo " " &gt;&gt; $ROOTPATH/scripts/rebuild.log
echo "Rebuild Started at `date`" &gt;&gt; $LOG

# Checkout the site if its not already there
if [ !  -d $ROOTPATH/svn ]
 then
 echo "Creating svn folder" &gt;&gt; $LOG
 mkdir $ROOTPATH/svn &gt;&gt; $LOG
 echo "Checking out working copy" &gt;&gt; $LOG
 svn co --username $SVNUSER --password $SVNPASS --non-interactive --no-auth-cache $SVNURL $ROOTPATH/svn &gt;&gt; $LOG
fi

# Update SVN (Currently from trunk but a tag might be better)
echo "- Update the working copy" &gt;&gt; $LOG
svn update --username $SVNUSER --password $SVNPASS --non-interactive --no-auth-cache $ROOTPATH/svn &gt;&gt; $LOG

# Export filebase
echo "- Export to public_tmp"  &gt;&gt; $LOG
svn export $ROOTPATH/svn $ROOTPATH/public_tmp &gt;&gt; $LOG

# Delete the current public folder
echo "- Delete the current public folder" &gt;&gt; $LOG
rm -fr $ROOTPATH/public &gt;&gt; $LOG

# Rename the checkout folder to public making it live
echo "- Rename public_tmp to public" &gt;&gt; $LOG
mv $ROOTPATH/public_tmp $ROOTPATH/public &gt;&gt; $LOG

# Set permissions on new public folder
echo "- Set permissions to public folder" &gt;&gt; $LOG
chown -Rf www-data:www-data $ROOTPATH/public &gt;&gt; $LOG
find $ROOTPATH/public -type f -exec chmod 644 {} \; &gt;&gt; $LOG
find $ROOTPATH/public -type d -exec chmod 755 {} \; &gt;&gt; $LOG

# Drop the db
echo "- Drop the database" &gt;&gt; $LOG
mysqladmin -u $DBUSER --password=$DBPASS --force DROP $DB &lt; $ROOTPATH/$DBSCRIPT &gt;&gt; $LOG

# Create the db
echo "- Create the database" &gt;&gt; $ROOTPATH/scripts/rebuild.log
mysqladmin -u $DBUSER --password=$DBPASS CREATE $DB &lt; $ROOTPATH/$DBSCRIPT &gt;&gt; $LOG

# Reload the sql
echo "- Recreate the database" &gt;&gt; $LOG
mysql -u $DBUSER --password=$DBPASS $DB &lt; $ROOTPATH/$DBSCRIPT &gt;&gt; $LOG

# Delete th sql script
echo "- Remove the SQL script" &gt;&gt; $LOG
rm -rf $ROOTPATH/$DBSCRIPT &gt;&gt; $LOG

END=$(date +%s)
DIFF=$(( $END - $START ))
echo "Rebuild completed in $DIFF seconds" &gt;&gt; $LOG
echo " " &gt;&gt; $LOG</pre>

<p>Before running the script you need to configure the parameters. Once that’s done you can run the script from command line using:</p>

<pre class="brush:bash">sh rebuild.sh</pre>

<h3 id="logging-always-nice-to-have">Logging, always nice-to-have</h3>

<p>Initially, just to debug, I added very rudimentary logging. But I then got carried away and decided to leave it there. Viewing the log you will see what has been happening. Log file will have entries similar to this:</p>

<pre class="brush:bash">Rebuild Started at Fri Feb  4 08:40:27 UTC 2011
- Update the working copy
At revision 71.
- Export to public_tmp
Export complete.
- Delete the current public folder
- Rename public_tmp to public
- Set permissions to public folder
- Drop the database
Database "demo_database" dropped
- Create the database
- Recreate the database
- Remove the SQL script
Rebuild completed in 13 seconds</pre>

<p>Note that this file will get bigger each time the script is run so especially if you’re going to use a cron job either remove the logging or periodically delete the log file.</p>

<h3 id="let8217s-automate-the-script">Let’s automate the script</h3>

<p>Lastly create a cron job to run the script and your rebuild is fully automated. Start by invoking Crontab editor with:</p>

<pre class="brush:bash">crontab -e</pre>

<p>You may be prompted to select an editor. You can then set the time and the path to the script. For example to run an hourly script on the hour you would add:</p>

<pre class="brush:bash">0 * * * * /path/to/rebuild.sh</pre>

<p>Save and your done. Your rebuild script should run every hour on the hour. Check if it is running by viewing the log.</p>

<p>That’s it, you now have an automatically rebuilt site. Enjoy!</p>


                    
                    <hr>
                    <div id="disqus_thread"></div>
                    <script type="text/javascript">
                        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                        var disqus_shortname = 'nooku'; // required: replace example with your forum shortname
                        var disqus_identifier = '225055952';
                        var disqus_url = 'http://blog.nooku.org/blog/2011/02/rebuilding-demo-site-automatically/';

                        /* * * DON'T EDIT BELOW THIS LINE * * */
                        (function() {
                            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                        })();
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                </div>
                <div class="col-sm-3">
                    <ul>
                        
                            
                            
                            
                                <li><a href="/blog/2013/03">March 2013</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2012/09">September 2012</a></li>
                                 
                            
                        
                            
                            
                            
                                <li><a href="/blog/2012/06">June 2012</a></li>
                                 
                            
                        
                            
                            
                            
                                <li><a href="/blog/2012/05">May 2012</a></li>
                                 
                            
                        
                            
                            
                            
                                <li><a href="/blog/2012/04">April 2012</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2012/03">March 2012</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2012/01">January 2012</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2011/12">December 2011</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2011/11">November 2011</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2011/10">October 2011</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2011/09">September 2011</a></li>
                                 
                            
                        
                            
                            
                            
                                <li><a href="/blog/2011/08">August 2011</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2011/07">July 2011</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2011/05">May 2011</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2011/04">April 2011</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2011/03">March 2011</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2011/02">February 2011</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2011/01">January 2011</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2010/12">December 2010</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2010/11">November 2010</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2010/10">October 2010</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2010/09">September 2010</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2010/08">August 2010</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2010/07">July 2010</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2010/06">June 2010</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2010/05">May 2010</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2010/04">April 2010</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2010/03">March 2010</a></li>
                                 
                            
                        
                            
                            
                            
                                <li><a href="/blog/2009/11">November 2009</a></li>
                                 
                            
                        
                            
                            
                            
                                <li><a href="/blog/2009/09">September 2009</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2009/08">August 2009</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2009/07">July 2009</a></li>
                                 
                            
                        
                            
                            
                            
                                <li><a href="/blog/2009/06">June 2009</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2009/05">May 2009</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2009/04">April 2009</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2009/03">March 2009</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2008/11">November 2008</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2008/09">September 2008</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2008/08">August 2008</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2008/06">June 2008</a></li>
                                 
                            
                        
                            
                            
                            
                                <li><a href="/blog/2008/05">May 2008</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                                <li><a href="/blog/2008/04">April 2008</a></li>
                                 
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                            
                            
                            
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>

<div class="section footer">
    <div class="container">
        <div class="row">
            <div class="col-sm-6">
                <p>
                    <a href="http://www.facebook.com/nooku.org">Facebook</a> |
                    <a href="http://www.twitter.com/nooku">Twitter</a> |
                    <a href="http://www.github.com/nooku">Github</a> |
                    <a href="/blog/rss.xml">RSS</a>
                </p>
            </div>
            <div class="copyright col-sm-6">
                <p>Copyright now <a href="http://www.timble.net">Timble</a></p>
            </div>
        </div>
    </div>
</div>
</div>
<a href="http://www.reactivemanifesto.org/"> <img style="border: 0; position: absolute; right: 0; top:0; z-index: 9000" src="//d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-white-right.png"> </a>
</body>
</html>